<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tính thể tích truyền dịch - Phần mềm dành cho bác sĩ thú y</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Pacifico&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
    <style>
        /* ĐÂY LÀ CSS CHÍNH, KHÔNG THỂ XÓA */
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: #e0f2f7;
            color: #333;
            display: flex;
            flex-direction: column;
            min-height: 100vh;
            margin: 0;
            line-height: 1.6;
        }
        main {
            flex-grow: 1;
        }
        .btn-start {
            background-color: #4CAF50;
        }
        .btn-start:hover {
            background-color: #45a049;
        }
        .btn-stop {
            background-color: #f44336;
        }
        .btn-stop:hover {
            background-color: #e53935;
        }
        .btn-count {
            background-color: #2196F3;
        }
        .btn-count:hover {
            background-color: #1e88e5;
        }
        .btn-disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

    </style>
</head>
<body>
    <div id="header-placeholder"></div>
<!--    <main class="flex-grow container mx-auto p-4"> --!>
    <main class="flex-grow max-w-md mx-auto p-4 md:p-6 lg:p-8">
        <div class="bg-white p-4 md:p-6 rounded-xl shadow-lg border-2 border-slate-200">
            <h1 class="text-center text-blue-600 text-2xl md:text-3xl font-bold mb-6">
                Công cụ tính Thể tích dịch truyền cho Chó/Mèo
            </h1>

            <div class="text-xl md:text-2xl text-center text-gray-700 font-bold border-b-2 border-gray-300 pb-2 mb-4 mt-6">
                1. KHAI BÁO
            </div>
            <div class="mb-4">
                <label for="weight" class="block font-semibold mb-1">Trọng lượng (kg):</label>
                <input type="number" id="weight" step="0.1" placeholder="Ví dụ: 5.5" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="mb-4">
                <label for="body-mass" class="block font-semibold mb-1">Chỉ số cơ thể:</label>
                <select id="body-mass" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="normal">Bình thường</option>
                    <option value="fat">Béo</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="dehydration-percent" class="block font-semibold mb-1">Phần trăm mất nước (%):</label>
                <select id="dehydration-percent" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="5">5% (bình thường)</option>
                    <option value="6">6%</option>
                    <option value="9">9%</option>
                    <option value="12">12%</option>
                    <option value="15">15%</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="resp-fluid-loss" class="block font-semibold mb-1">Thể tích mất nước hô hấp (ml):</label>
                <span class="text-sm text-gray-500 block mb-1">Gọi tắt là V hô hấp. Công thức = số giờ x 7 x trọng lượng</span>
                <input type="number" id="resp-fluid-loss" placeholder="Nhập giá trị hoặc để 0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="mb-4">
                <label for="digestive-fluid-loss" class="block font-semibold mb-1">Thể tích mất nước tiêu hóa (ml):</label>
                <span class="text-sm text-gray-500 block mb-1">Gọi tắt là V tiêu hóa. Định lượng bằng cốc đong.</span>
                <input type="number" id="digestive-fluid-loss" placeholder="Nhập giá trị hoặc để 0" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>

            <div class="border-t border-dashed border-gray-500 my-8"></div>

            <div class="text-xl md:text-2xl text-center text-gray-700 font-bold border-b-2 border-gray-300 pb-2 mb-4 mt-6">
                2. KHI BỆNH THÚ MỚI ĐẾN
            </div>
            <button onclick="calculateArrivalFluid()" class="w-full p-3 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition duration-300">
                Tính toán
            </button>
            <div class="mb-4 mt-4">
                <label for="arrival-volume-12h" class="block font-semibold mb-1">Thể tích dịch truyền trong 12H (ml):</label>
                <span class="text-sm text-gray-500 block mb-1">= % mất nước x "cân nặng trừ mỡ" x 10</span>
                <input type="text" id="arrival-volume-12h" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>
            <p class="text-center font-bold mt-6 mb-2">Chia ra:</p>
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="arrival-v-gluco-30" class="block font-semibold mb-1">V Gluco 30% (ml):</label>
                        <input type="text" id="arrival-v-gluco-30" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="arrival-v-other-30" class="block font-semibold mb-1">=> Thể tích các loại dịch khác (ml):</label>
                        <input type="text" id="arrival-v-other-30" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
            </div>
            <p class="text-center font-bold mt-6 mb-2">Hoặc:</p>
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="arrival-v-gluco-5" class="block font-semibold mb-1">V Gluco 5% (ml):</label>
                        <input type="text" id="arrival-v-gluco-5" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="arrival-v-other-5" class="block font-semibold mb-1">=> Thể tích các loại dịch khác (ml):</label>
                        <input type="text" id="arrival-v-other-5" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
            </div>

            <div class="border-t border-dashed border-gray-500 my-8"></div>

            <div class="text-xl md:text-2xl text-center text-gray-700 font-bold border-b-2 border-gray-300 pb-2 mb-4 mt-6">
                3. KHI BỆNH THÚ NẰM VIỆN
            </div>
            <p class="text-sm text-blue-600 text-center mb-4">
                Bước này sẽ bắt đầu khi BSTY đã hoàn thành việc truyền đủ nước cho bệnh thú ở bước trên, có nghĩa là "Phần trăm mất nước" đã về mức Bình thường. Nếu tình trạng mất nước chưa được cải thiện, BSTY vẫn phải truyền theo liều lượng ở bước 2.
            </p>
            <button onclick="calculateHospitalFluid()" class="w-full p-3 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition duration-300">
                Tính toán
            </button>
            <div class="mb-4 mt-4">
                <label for="hospital-volume-24h" class="block font-semibold mb-1">Tổng thể tích dịch truyền trong 1 ngày (ml):</label>
                <span class="text-sm text-gray-500 block mb-1">= 97 x ("cân nặng trừ mỡ" lũy thừa 0.655) + V hô hấp + V tiêu hóa</span>
                <input type="text" id="hospital-volume-24h" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>
            <p class="text-center font-bold mt-6 mb-2">Chia ra:</p>
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="hospital-v-gluco-30" class="block font-semibold mb-1">V Gluco 30% (ml):</label>
                        <input type="text" id="hospital-v-gluco-30" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="hospital-v-other-30" class="block font-semibold mb-1">=> Thể tích các loại dịch khác (ml):</label>
                        <input type="text" id="hospital-v-other-30" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
            </div>
            <p class="text-center font-bold mt-6 mb-2">Hoặc:</p>
            <div class="flex flex-wrap gap-4">
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="hospital-v-gluco-5" class="block font-semibold mb-1">V Gluco 5% (ml):</label>
                        <input type="text" id="hospital-v-gluco-5" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
                <div class="flex-1 min-w-[250px]">
                    <div class="mb-4">
                        <label for="hospital-v-other-5" class="block font-semibold mb-1">=> Thể tích các loại dịch khác (ml):</label>
                        <input type="text" id="hospital-v-other-5" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
                    </div>
                </div>
            </div>

            <div class="border-t border-dashed border-gray-500 my-8"></div>

            <div class="text-xl md:text-2xl text-center text-gray-700 font-bold border-b-2 border-gray-300 pb-2 mb-4 mt-6">
                4. THỜI GIAN TRUYỀN DỰA VÀO TỐC ĐỘ NHỎ GIỌT
            </div>
            <div class="mb-4">
                <label for="drip-factor" class="block font-semibold mb-1">Thông số dây:</label>
                <span class="text-sm text-gray-500 block mb-1">Xem trên bao bì nhà sản xuất ghi bao nhiêu giọt/1ml ?</span>
                <select id="drip-factor" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="20">20</option>
                    <option value="15">15</option>
                </select>
            </div>
            <div class="mb-4">
                <label for="drip-rate" class="block font-semibold mb-1">Tốc độ nhỏ giọt đếm được:</label>
                <span class="text-sm text-gray-500 block mb-1">BSTY sẽ quan sát thực tế xem trong 1 phút có bao nhiêu giọt nhỏ xuống ?</span>
                <input type="number" id="drip-rate" placeholder="ví dụ: 30 giọt/phút" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="mb-4">
                <label for="volume-to-infuse" class="block font-semibold mb-1">Thể tích muốn truyền (ml):</label>
                <span class="text-sm text-gray-500 block mb-1">BSTY phải nhập thể tích đã tính toán ở các phần trên vào đây</span>
                <input type="number" id="volume-to-infuse" placeholder="ví dụ: 500" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="mb-4">
                <label for="start-time" class="block font-semibold mb-1 text-gray-700">Giờ bắt đầu truyền:</label>
                <div class="flex items-center gap-2">
                    <input type="text" id="start-time" placeholder="nhập theo định dạng 13:33" class="flex-grow p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <button onclick="getCurrentTime()" class="p-2 bg-blue-500 text-white font-semibold rounded-md hover:bg-blue-600 transition duration-300 flex-shrink-0 whitespace-nowrap">Lấy giờ</button>
                </div>
            </div>
            <button onclick="calculateInfusion()" class="w-full p-3 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition duration-300">
                Tính toán
            </button>
            <div class="mb-4 mt-4">
                <label for="infusion-time" class="block font-semibold mb-1">=> Thời gian cần truyền dự kiến:</label>
                <input type="text" id="infusion-time" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>
            <div class="mb-4">
                <label for="end-time" class="block font-semibold mb-1">=> Sẽ kết thúc truyền lúc:</label>
                <input type="text" id="end-time" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>

            <div class="border-t border-dashed border-gray-500 my-8"></div>

            <div class="text-xl md:text-2xl text-center text-gray-700 font-bold border-b-2 border-gray-300 pb-2 mb-4 mt-6">
                5. ƯỚC LƯỢNG
            </div>
            <p class="text-sm text-blue-600 text-center mb-4">
                Công cụ này giúp BSTY ước lượng 1 cách tương đối lượng dịch đã được truyền vào cơ thể bệnh thú, vì bỏ qua các vấn đề có thể làm sai lệch kết quả do thú bệnh gây ra như: xoắn/gập ống truyền dịch, con thú gập chân dẫn đến ven không thông hoặc các vấn đề gây rò rỉ dịch truyền...
            </p>
            <button onclick="calculateEstimation()" class="w-full p-3 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition duration-300">
                Ước lượng
            </button>
            <div class="mb-4 mt-4">
                <label for="start-time-estimation" class="block font-semibold mb-1">Thời gian bắt đầu truyền:</label>
                <span class="text-sm text-gray-500 block mb-1">Tự động lấy từ ô "Giờ bắt đầu truyền" ở khung "4. THỜI GIAN TRUYỀN DỰA VÀO TỐC ĐỘ NHỎ GIỌT"</span>
                <input type="text" id="start-time-estimation" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>
            <div class="mb-4">
                <label for="estimated-minutes" class="block font-semibold mb-1">Ước lượng thời gian đã trôi qua:</label>
                <span class="text-sm text-gray-500 block mb-1">Tự động lấy giờ tại thời điểm nhấn nút "Ước lượng" trừ cho giờ trong ô "Thời gian bắt đầu truyền"</span>
                <input type="text" id="estimated-minutes" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>
            <div class="mb-4">
                <label for="estimated-volume" class="block font-semibold mb-1">Ước lượng tổng thể tích đã truyền (ml):</label>
                <input type="text" id="estimated-volume" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>

            <div class="border-t border-dashed border-gray-500 my-8"></div>

            <div class="text-xl md:text-2xl text-center text-gray-700 font-bold border-b-2 border-gray-300 pb-2 mb-4 mt-6">
                6. CÔNG CỤ TÍNH TỐC ĐỘ NHỎ GIỌT
            </div>
            <p class="text-sm text-blue-600 text-center mb-4">
                Công cụ này giúp BSTY có được thông số tốc độ nhỏ giọt trung bình, mà không cần phải quan sát trong 1 phút có bao nhiêu giọt nhỏ xuống. Công cụ này dựa trên việc cứ thấy 1 giọt nhỏ xuống thì bấm vào nút "Đếm giọt" 1 lần, nó sẽ dựa vào thời gian đã trôi qua để suy ra tốc độ.
            </p>
            <div class="flex flex-col md:flex-row gap-4">
                <button onclick="startStopTimer()" id="timer-button" class="w-full p-3 text-white font-bold rounded-md transition duration-300 btn-start">
                    Bắt đầu
                </button>
                <button onclick="countDrop()" id="count-button" disabled class="w-full p-3 text-white font-bold rounded-md btn-disabled">
                    Đếm giọt
                </button>
                <button onclick="resetTimer()" id="reset-button" class="w-full p-3 bg-red-500 text-white font-bold rounded-md hover:bg-red-600 transition duration-300">
                    Đặt lại
                </button>
            </div>
            <div class="mb-4 mt-4">
                <label class="block font-semibold mb-1 text-center">Thời gian đã trôi qua:</label>
                <div id="elapsed-time" class="text-5xl font-bold text-center text-red-600 mt-2">00:00</div>
            </div>
            <div class="mb-4">
                <label class="block font-semibold mb-1 text-center">Tổng số giọt đã đếm:</label>
                <div id="drip-count" class="text-5xl font-bold text-center text-red-600 mt-2">0</div>
            </div>
            <div class="mb-4">
                <label for="calculated-drip-rate" class="block font-semibold mb-1">=> Tốc độ nhỏ giọt (giọt/phút):</label>
                <input type="text" id="calculated-drip-rate" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>

            <div class="border-t border-dashed border-gray-500 my-8"></div>

            <div class="text-xl md:text-2xl text-center text-gray-700 font-bold border-b-2 border-gray-300 pb-2 mb-4 mt-6">
                7. CÔNG CỤ TÍNH TỐC ĐỘ NHỎ GIỌT THEO THỜI GIAN
            </div>
            <p class="text-sm text-blue-600 text-center mb-4">
                Công cụ này giúp BSTY tính ra tốc độ nhỏ giọt là bao nhiêu để truyền hết một thể tích cần thiết trong một khoảng thời gian mong muốn.
            </p>
            <div class="mb-4">
                <label for="volume-predetermined" class="block font-semibold mb-1">Thể tích muốn truyền (ml):</label>
                <input type="number" id="volume-predetermined" placeholder="ví dụ: 500" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="mb-4">
                <label for="time-predetermined" class="block font-semibold mb-1">Thời gian truyền dự kiến (phút):</label>
                <input type="number" id="time-predetermined" placeholder="ví dụ: 60" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
            </div>
            <div class="mb-4">
                <label for="drip-factor-predetermined" class="block font-semibold mb-1">Thông số dây:</label>
                <span class="text-sm text-gray-500 block mb-1">Xem trên bao bì nhà sản xuất ghi bao nhiêu giọt/1ml ?</span>
                <select id="drip-factor-predetermined" class="w-full p-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="20">20</option>
                    <option value="15">15</option>
                </select>
            </div>
            <button onclick="calculatePredeterminedDripRate()" class="w-full p-3 bg-green-500 text-white font-bold rounded-md hover:bg-green-600 transition duration-300">
                Tính toán
            </button>
            <div class="mb-4 mt-4">
                <label for="result-drip-rate" class="block font-semibold mb-1">=> Tốc độ nhỏ giọt cần thiết (giọt/phút):</label>
                <input type="text" id="result-drip-rate" readonly class="w-full p-2 border border-gray-300 rounded-md bg-gray-100 cursor-not-allowed">
            </div>
        </div>


        <!-- Dưới đây là modal thông báo lỗi và xác nhận tuỳ chỉnh, thay thế cho các hàm alert() và confirm() -->
        <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-10 hidden opacity-0 transition-opacity duration-300">
            <div class="bg-white rounded-lg shadow-xl p-6 md:p-8 max-w-sm w-full mx-4 transform scale-95 transition-transform duration-300 relative">
                <button id="closeMessageModalBtn" class="absolute top-3 right-3 text-gray-400 hover:text-gray-600 transition-colors duration-200">
                    <i class="fas fa-times text-xl"></i>
                </button>
                <div class="text-center">
                    <i class="fas fa-exclamation-triangle text-4xl text-yellow-500 mb-4"></i>
                    <h2 class="text-xl font-bold text-gray-800 mb-2">Thông báo</h2>
                    <p id="message-text" class="text-gray-600 mb-4">Nội dung thông báo lỗi.</p>
                    <button id="okMessageModalBtn" class="bg-blue-500 hover:bg-blue-600 text-white font-semibold py-2 px-4 rounded-lg transition-colors duration-300">OK</button>
                </div>
            </div>
        </div>

    </main>
    <div id="donate-placeholder"></div>
    <div id="footer-placeholder"></div>
    <div id="modals-placeholder"></div>

    <!-- Custom Modal for Messages -->
    <div id="messageModal" class="fixed inset-0 z-50 flex items-center justify-center bg-black bg-opacity-50 hidden opacity-0 transition-opacity duration-300">
        <div class="bg-white rounded-lg shadow-xl p-6 max-w-sm w-full mx-4">
            <h3 id="messageTitle" class="text-xl font-bold mb-2"></h3>
            <p id="messageContent" class="text-gray-700 mb-4"></p>
            <button id="closeMessageModalBtn" class="w-full p-2 bg-blue-500 text-white font-bold rounded-md hover:bg-blue-600">Đóng</button>
        </div>
    </div>
    
    <script>

// Các hàm tính toán chính cho ứng dụng
// Custom function to show a message modal instead of alert()
/**
 * @fileoverview Main JavaScript logic for the veterinary calculator mini-app.
 * This script contains functions for various calculations related to fluid therapy,
 * including calculating fluid volumes for hospitalized patients and estimating
 * infusion times. It also includes functions for a manual drip counter.
 */

// Global variables for the drip counter functionality.
let timer;
let seconds = 0;
let drops = 0;

/**
         * Custom function to show a message modal instead of alert().
         * @param {string} message The message to display in the modal.
         */
        function showMessage(message) {
            const messageModal = document.getElementById('messageModal');
            const messageText = document.getElementById('message-text');
            messageText.textContent = message;
            messageModal.classList.remove('hidden');
            setTimeout(() => {
                messageModal.classList.remove('opacity-0');
            }, 10);
        }

        /**
         * Custom function to hide the message modal.
         */
        function hideMessage() {
            const messageModal = document.getElementById('messageModal');
            messageModal.classList.add('opacity-0');
            setTimeout(() => {
                messageModal.classList.add('hidden');
            }, 300);
        }

        /**
         * Adds event listeners to the message modal buttons when the DOM is loaded.
         */
        document.addEventListener("DOMContentLoaded", function() {
            const okBtn = document.getElementById('okMessageModalBtn');
            const closeBtn = document.getElementById('closeMessageModalBtn');
            const messageModal = document.getElementById('messageModal');

            if (okBtn) {
                okBtn.addEventListener('click', hideMessage);
            }
            if (closeBtn) {
                closeBtn.addEventListener('click', hideMessage);
            }
            // Close modal when clicking outside of it
            if (messageModal) {
                messageModal.addEventListener('click', (event) => {
                    if (event.target === messageModal) {
                        hideMessage();
                    }
                });
            }
        });

// Hàm tính thể tích dịch truyền cho bệnh nhân nhập viện
/**
 * Calculates the fluid volume for a newly admitted patient based on weight,
 * body condition, and dehydration percentage.
 */
function calculateArrivalFluid() {
    const weight = parseFloat(document.getElementById('weight').value);
    const bodyMass = document.getElementById('body-mass').value;
    const dehydrationPercent = parseFloat(document.getElementById('dehydration-percent').value);

    if (isNaN(weight) || weight <= 0) {
        showMessage('Lỗi nhập liệu: Vui lòng nhập cân nặng hợp lệ.');
        return;
    }
    
    // Tính cân nặng thực tế dựa trên thể trạng
    const realWeight = (bodyMass === 'fat') ? weight * 0.8 : weight;
    const arrivalVolume12h = (dehydrationPercent * realWeight * 10);
    
    document.getElementById('arrival-volume-12h').value = `${arrivalVolume12h.toFixed(2)} ml`;
    
    // Tính toán thể tích dịch cho tỷ lệ Gluco 30%
    const arrivalVOther30 = arrivalVolume12h * 0.7;
    const arrivalVGluco30 = arrivalVolume12h * 0.3;
    document.getElementById('arrival-v-gluco-30').value = `${arrivalVGluco30.toFixed(2)} ml`;
    document.getElementById('arrival-v-other-30').value = `${arrivalVOther30.toFixed(2)} ml`;

    // Tính toán thể tích dịch cho tỷ lệ Gluco 5%
    const arrivalVOther5 = arrivalVolume12h * 0.95;
    const arrivalVGluco5 = arrivalVolume12h * 0.05;
    document.getElementById('arrival-v-gluco-5').value = `${arrivalVGluco5.toFixed(2)} ml`;
    document.getElementById('arrival-v-other-5').value = `${arrivalVOther5.toFixed(2)} ml`;
}

// Hàm tính thể tích dịch truyền cho bệnh nhân đang nằm viện
/**
 * Calculates the total 24-hour fluid volume for a hospitalized patient,
 * including maintenance needs and estimated fluid losses.
 */
function calculateHospitalFluid() {
    const weight = parseFloat(document.getElementById('weight').value);
    const bodyMass = document.getElementById('body-mass').value;
    const respFluidLoss = parseFloat(document.getElementById('resp-fluid-loss').value) || 0;
    const digestiveFluidLoss = parseFloat(document.getElementById('digestive-fluid-loss').value) || 0;

    if (isNaN(weight) || weight <= 0) {
        showMessage('Lỗi nhập liệu: Vui lòng nhập cân nặng hợp lệ.');
        return;
    }
    
    // Tính cân nặng thực tế dựa trên thể trạng
    const realWeight = (bodyMass === 'fat') ? weight * 0.8 : weight;
    
    // Công thức tính thể tích dịch 24h
    const hospitalVolume24h = (97 * Math.pow(realWeight, 0.655)) + respFluidLoss + digestiveFluidLoss;
    
    document.getElementById('hospital-volume-24h').value = `${hospitalVolume24h.toFixed(2)} ml`;

    // Tính toán thể tích dịch cho tỷ lệ Gluco 30%
    const hospitalVOther30 = hospitalVolume24h * 0.7;
    const hospitalVGluco30 = hospitalVolume24h * 0.3;
    document.getElementById('hospital-v-gluco-30').value = `${hospitalVGluco30.toFixed(2)} ml`;
    document.getElementById('hospital-v-other-30').value = `${hospitalVOther30.toFixed(2)} ml`;

    // Tính toán thể tích dịch cho tỷ lệ Gluco 5%
    const hospitalVOther5 = hospitalVolume24h * 0.95;
    const hospitalVGluco5 = hospitalVolume24h * 0.05;
    document.getElementById('hospital-v-gluco-5').value = `${hospitalVGluco5.toFixed(2)} ml`;
    document.getElementById('hospital-v-other-5').value = `${hospitalVOther5.toFixed(2)} ml`;
}

// Hàm lấy thời gian hiện tại để điền vào ô input
/**
 * Fills the start time input field with the current time.
 */
function getCurrentTime() {
    const now = new Date();
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    document.getElementById('start-time').value = `${hours}:${minutes}`;
}
    
// Hàm tính thời gian truyền dịch dự kiến
/**
 * Calculates the estimated infusion duration and end time based on drip rate,
 * volume, and start time.
 */
function calculateInfusion() {
    const dripRate = parseFloat(document.getElementById('drip-rate').value);
    const volume = parseFloat(document.getElementById('volume-to-infuse').value);
    const startTimeString = document.getElementById('start-time').value;

    if (isNaN(dripRate) || isNaN(volume) || dripRate <= 0 || volume <= 0 || !startTimeString) {
        showMessage('Lỗi nhập liệu: Vui lòng nhập Giờ bắt đầu, Tốc độ nhỏ giọt và Thể tích muốn truyền hợp lệ.');
        return;
    }

    const startTimeParts = startTimeString.split(':');
    const startHour = parseInt(startTimeParts[0]);
    const startMinute = parseInt(startTimeParts[1]);

    const dripFactor = parseFloat(document.getElementById('drip-factor').value);
    const totalDrops = volume * dripFactor;
    const estimatedMinutes = totalDrops / dripRate;
    
    const endTotalMinutes = startHour * 60 + startMinute + estimatedMinutes;
    const endHour = Math.floor(endTotalMinutes / 60) % 24;
    const endMinute = Math.floor(endTotalMinutes % 60);

    const endHourPadded = String(endHour).padStart(2, '0');
    const endMinutePadded = String(endMinute).padStart(2, '0');

    document.getElementById('infusion-time').value = `${Math.floor(estimatedMinutes)} phút`;
    document.getElementById('end-time').value = `${endHourPadded}:${endMinutePadded}`;
    document.getElementById('start-time-estimation').value = startTimeString;
}

// Hàm tính thể tích dịch truyền dự kiến dựa trên thời gian đã trôi qua
/**
 * Calculates the estimated volume infused based on the elapsed time and drip rate.
 */
function calculateEstimation() {
    const dripRate = parseFloat(document.getElementById('drip-rate').value);
    const startTimeString = document.getElementById('start-time').value;

    if (isNaN(dripRate) || dripRate <= 0 || !startTimeString) {
        showMessage('Lỗi nhập liệu: Vui lòng nhập Tốc độ nhỏ giọt và Giờ bắt đầu.');
        return;
    }

    const startTimeParts = startTimeString.split(':');
    const startHour = parseInt(startTimeParts[0]);
    const startMinute = parseInt(startTimeParts[1]);

    const now = new Date();
    const nowHour = now.getHours();
    const nowMinute = now.getMinutes();

    const totalStartMinutes = startHour * 60 + startMinute;
    const totalNowMinutes = nowHour * 60 + nowMinute;
    
    let estimatedMinutes = totalNowMinutes - totalStartMinutes;
    if (estimatedMinutes < 0) {
        // Nếu qua ngày mới, thêm 24 giờ (1440 phút)
        estimatedMinutes += 24 * 60;
    }

    const estimatedVolume = (dripRate * estimatedMinutes) / parseFloat(document.getElementById('drip-factor').value);

    document.getElementById('estimated-minutes').value = `${Math.floor(estimatedMinutes)} phút`;
    document.getElementById('estimated-volume').value = `${estimatedVolume.toFixed(2)} ml`;
}

// Hàm bắt đầu/dừng đếm giờ
/**
 * Toggles the drip counter timer on and off.
 */
function startStopTimer() {
    const timerButton = document.getElementById('timer-button');
    const countButton = document.getElementById('count-button');

    if (timerButton.textContent === 'Bắt đầu') {
        timerButton.textContent = 'Dừng';
        timerButton.classList.remove('btn-start');
        timerButton.classList.add('btn-stop');
        countButton.disabled = false;
        countButton.classList.remove('btn-disabled');
        countButton.classList.add('btn-count');
        timer = setInterval(() => {
            seconds++;
            const minutes = Math.floor(seconds / 60);
            const remainingSeconds = seconds % 60;
            document.getElementById('elapsed-time').textContent = `${String(minutes).padStart(2, '0')}:${String(remainingSeconds).padStart(2, '0')}`;
            
            if (seconds > 0) {
                const dripRate = (drops / seconds) * 60;
                document.getElementById('calculated-drip-rate').value = `${dripRate.toFixed(2)} giọt/phút`;
            } else {
                document.getElementById('calculated-drip-rate').value = '';
            }
        }, 1000);
    } else {
        clearInterval(timer);
        timerButton.textContent = 'Bắt đầu';
        timerButton.classList.remove('btn-stop');
        timerButton.classList.add('btn-start');
        countButton.disabled = true;
        countButton.classList.remove('btn-count');
        countButton.classList.add('btn-disabled');
    }
}

// Hàm đếm số giọt
/**
 * Increments the drop count and updates the calculated drip rate.
 */
function countDrop() {
    drops++;
    document.getElementById('drip-count').textContent = drops;
    if (seconds > 0) {
        const dripRate = (drops / seconds) * 60;
        document.getElementById('calculated-drip-rate').value = `${dripRate.toFixed(2)} giọt/phút`;
    }
}

// Hàm đặt lại đồng hồ và số giọt
/**
 * Resets the timer and drip count to their initial states.
 */
function resetTimer() {
    clearInterval(timer);
    seconds = 0;
    drops = 0;
    const timerButton = document.getElementById('timer-button');
    const countButton = document.getElementById('count-button');
    timerButton.textContent = 'Bắt đầu';
    timerButton.classList.remove('btn-stop');
    timerButton.classList.add('btn-start');
    countButton.disabled = true;
    countButton.classList.remove('btn-count');
    countButton.classList.add('btn-disabled');
    document.getElementById('elapsed-time').textContent = '00:00';
    document.getElementById('drip-count').textContent = '0';
    document.getElementById('calculated-drip-rate').value = '';
}

// Hàm tính tốc độ nhỏ giọt dựa trên thể tích và thời gian định trước
/**
 * Calculates the drip rate based on a predetermined volume and time.
 */
function calculatePredeterminedDripRate() {
    const volume = parseFloat(document.getElementById('volume-predetermined').value);
    const time = parseFloat(document.getElementById('time-predetermined').value);
    const dripFactor = parseFloat(document.getElementById('drip-factor-predetermined').value);

    if (isNaN(volume) || isNaN(time) || volume <= 0 || time <= 0) {
        // ERROR FIX: Replaced alert() with showMessage() for consistent UI.
        showMessage('Lỗi nhập liệu: Vui lòng nhập Thể tích và Thời gian truyền hợp lệ.');
        return;
    }

    const dripRate = (volume * dripFactor) / time;
    document.getElementById('result-drip-rate').value = `${dripRate.toFixed(2)} giọt/phút`;
}
    </script>
</body>
</html>
